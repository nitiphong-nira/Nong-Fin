import { replyMessage, replyFlexMessage } from './utils.js';
import { 
  consentFlexMessage,
  userInfoFlexMessage,
  exampleFlexMessage 
} from './flex-messages.js';
import { checkUserConsent, saveConsentToSheets, saveUserInfoToSheets } from './sheets.js';

const userProfiles = new Map();
const userStates = new Map();

export async function handleConsent(event, userMsg, userId) {
  // Step 0: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Line ID ‡πÉ‡∏ô Sheets ‡∏Å‡πà‡∏≠‡∏ô
  const hasConsented = await checkUserConsent(userId);
  
  if (hasConsented) {
    // Step 3: ‡πÄ‡∏Ñ‡∏¢‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß -> ‡πÑ‡∏õ Rich Menu
    await handleMainMenu(event, userMsg, userId);
  } else {
    // Step 1: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°
    await handleConsentFlow(event, userMsg, userId);
  }
}

async function handleConsentFlow(event, userMsg, userId) {
  // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  switch (userMsg) {
    case '‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°':
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Consent ‡∏•‡∏á Sheets
      await saveConsentToSheets(userId, '‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°');
      
      // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
      await replyFlexMessage(event.replyToken, userInfoFlexMessage(userId));
      userStates.set(userId, 'collecting_info');
      break;

    case '‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°':
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Consent ‡∏•‡∏á Sheets
      await saveConsentToSheets(userId, '‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°');
      
      await replyMessage(event.replyToken,
        `‚ùå ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
        
‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏à ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°" ‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤`
      );
      break;

    default:
      // ‡∏ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°"/"‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°" -> ‡∏™‡πà‡∏á Consent ‡πÉ‡∏´‡∏°‡πà
      await replyFlexMessage(event.replyToken, consentFlexMessage);
  }
}

async function handleUserInfoFlow(event, userMsg, userId) {
  switch (userMsg) {
    case '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å':
      await replyFlexMessage(event.replyToken, exampleFlexMessage);
      break;

    case '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•':
      await replyMessage(event.replyToken,
        `üìù ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:
‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏≠‡∏µ‡πÄ‡∏°‡∏•

‡πÄ‡∏ä‡πà‡∏ô: ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ somchai@gmail.com`
      );
      break;

    case '‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å':
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å
      await saveUserInfoToSheets(userId, { skipped: true });
      userStates.delete(userId);
      
      await replyMessage(event.replyToken,
        `‚úÖ ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß

‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢! üöÄ`
      );
      break;

    default:
      // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      await processUserInfo(event, userMsg, userId);
  }
}

async function processUserInfo(event, userMsg, userId) {
  const parts = userMsg.split(' ');
  
  if (parts.length >= 3) {
    const firstName = parts[0];
    const lastName = parts[1];
    const email = parts[2];

    if (!email.includes('@')) {
      await replyMessage(event.replyToken,
        `‚ùå ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        
‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏áÊ†ºÂºè`
      );
      return;
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡∏á Sheets
    const userData = {
      firstName,
      lastName,
      email,
      timestamp: new Date().toISOString()
    };

    await saveUserInfoToSheets(userId, userData);
    userProfiles.set(userId, userData);
    userStates.delete(userId);

    await replyMessage(event.replyToken,
      `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!
‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì ${firstName}

‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß üöÄ`
    );

  } else {
    // ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    await replyMessage(event.replyToken,
      `‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å: ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏≠‡∏µ‡πÄ‡∏°‡∏•

‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° "‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å" ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`
    );
  }
}

async function handleMainMenu(event, userMsg, userId) {
  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Rich Menu ‡∏´‡∏•‡∏±‡∏Å
  // (‡∏à‡∏∞ implement ‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ô Phase ‡∏ï‡πà‡∏≠‡πÑ‡∏õ)
  await replyMessage(event.replyToken,
    `üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö!

‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
    
‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ:
‚Ä¢ üìä ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ
‚Ä¢ üìà ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô  
‚Ä¢ üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï
‚Ä¢ üéØ ‡πÅ‡∏ú‡∏ô‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì
‚Ä¢ üíµ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢`
  );
}
